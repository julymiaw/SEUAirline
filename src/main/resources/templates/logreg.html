<!doctype html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <title>注册/登录页面</title>
    <style>
        body {
            font-family: "Trebuchet MS", sans-serif;
            margin: 0;
            padding: 0;
        }


        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .hd {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #ffffff;
            /* 白色背景 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 0 20px;
            height: 5vh;
        }

        .nav-links {
            display: flex;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #555555;
            /* 灰色文本 */
            font-size: 16px;
            margin: 0 10px;
            padding: 10px;
            transition: background-color 0.3s, color 0.3s;
        }

        .nav-links a:hover {
            background-color: #f4f4f4;
            /* 灰色背景 */
            color: #ff0000;
            /* 红色文本 */
        }

        .company-name {
            font-size: 18px;
            font-weight: bold;
            color: darkgreen;
        }

        .login {
            min-height: 60%;
            height: 95vh;
            background: url('/images/login_background.jpg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .login .login-box {
            position: absolute;
            top: 50%;
            left: 75%;
            transform: translate(-50%, -50%);
        }

        .login-box {
            width: 350px;
            background: #fff;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            padding: 20px 30px 20px 30px;
        }

        .box-item-nav {
            height: 37px;
            margin-bottom: 20px;
        }

        .box-item-nav .item-li {
            float: left;
            color: #bdbdbd;
            font-size: 14px;
            text-align: center;
            width: 50%;
            height: 37px;
            line-height: 37px;
            cursor: pointer;
        }

        .box-item-nav .item-li-on {
            background-color: #d7000f;
            color: white;
        }

        .box-item-con .item {
            display: none;
        }

        .box-item-con .item.active {
            display: block;
        }

        .ui-button {
            width: 100%;
            margin-top: 10px;
        }

        .input-item .input {
            display: block;
            width: 95%;
            font-size: 16px;
            color: #333;
            background: #fff;
            border: 1px solid #dadfe3;
            padding-left: 5%;
            height: 50px;
            line-height: 50px;
            border-radius: 4px;
            -webkit-appearance: none;
            outline: 0;
        }

        .btn {
            display: inline-block;
            min-width: 80px;
            padding: 0 20px;
            height: 36px;
            line-height: 36px;
            background-color: #d8000f;
            text-align: center;
            cursor: pointer;
            border: 1px solid #d8000f;
            border-radius: 4px;
            color: #fff;
        }

        .btn:hover {
            background-color: #ba000d;
        }

        .login-row {
            margin-bottom: 20px;
            line-height: 24px;
        }

        .login-row.login-btn {
            margin: 0 0 10px 0;
        }

        .btn.btn-form {
            width: 350px;
            height: 50px;
            line-height: 50px;
        }

        .btn-link {
            font-size: 14px;
            color: #2d83d8;
            cursor: pointer;
        }

        .login-row.login-tips .password-tip {
            float: right;
        }

        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            min-width: 250px;
            max-width: 400px;
            white-space: pre-line;
            line-height: 1.4;
        }

        .message-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-box.fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
    </style>
</head>

<body>
    <div class="hd">
        <div class="nav-links">
            <a href="/homepage">首页</a>
            <a href="/dashboard">用户主页</a>
            <a href="/">登录页面</a>
            <a href="/logout">登出</a>
        </div>
        <div class="company-name">东南航空</div>
    </div>

    <div class="login">
        <div class="login-box">
            <div class="box-item-nav">
                <span class="item-li item-li-on" data-target="#login">登录</span>
                <span class="item-li" data-target="#register">注册</span>
            </div>
            <div class="box-item-con">
                <div id="login" class="item active">
                    <form id="login-form">
                        <div class="login-row">
                            <div class="input-item">
                                <input type="text" id="login-identifier" name="identifier" class="input"
                                    placeholder="身份证号/手机号/邮箱">
                            </div>
                        </div>
                        <div class="login-row">
                            <div class="input-item">
                                <input type="password" id="login-password" name="password" class="input"
                                    placeholder="密码">
                            </div>
                        </div>
                        <div class="login-row login-btn">
                            <button type="submit" class="btn btn-form">登录</button>
                        </div>
                        <div class="login-row login-tips">
                            <a id="forgot-password" class="btn-link password-tip">忘记密码</a>
                        </div>
                    </form>
                </div>
                <div id="register" class="item">
                    <form id="register-form">
                        <div class="login-row">
                            <div class="input-item">
                                <input type="text" id="register-name" name="name" class="input" placeholder="姓名">
                            </div>
                        </div>
                        <div class="login-row">
                            <div class="input-item">
                                <input type="text" id="register-id" name="id" class="input" placeholder="身份证号">
                            </div>
                        </div>
                        <div class="login-row">
                            <div class="input-item">
                                <input type="text" id="register-phone" name="phone" class="input" placeholder="手机号">
                            </div>
                        </div>
                        <div class="login-row">
                            <div class="input-item">
                                <input type="email" id="register-email" name="email" class="input" placeholder="邮箱">
                            </div>
                        </div>
                        <div class="login-row">
                            <div class="input-item">
                                <input type="password" id="register-password" name="password" class="input"
                                    placeholder="密码">
                            </div>
                        </div>
                        <div class="login-row">
                            <div class="input-item">
                                <input type="password" id="register-confirm-password" name="confirm-password"
                                    class="input" placeholder="确认密码">
                            </div>
                        </div>
                        <div class="login-row login-btn">
                            <button type="submit" class="btn btn-form">注册</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="/js/vendor/jquery-ui-1.14.1.custom/jquery-ui.js"></script>
    <script>
        $(function () {
            $("button").button();

            $(".box-item-nav .item-li").on("click", function () {
                $(".box-item-nav .item-li").removeClass("item-li-on");
                $(this).addClass("item-li-on");
                $(".box-item-con .item").removeClass("active");
                $($(this).data("target")).addClass("active");
            });

            $("#login-form").on("submit", function (event) {
                event.preventDefault();

                const username = $("#login-identifier").val().trim();
                const password = $("#login-password").val();

                // 前端基础验证
                if (!username) {
                    showError("用户名不能为空");
                    return;
                }
                if (!password) {
                    showError("密码不能为空");
                    return;
                }

                $.ajax({
                    url: "/login",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ username, password }),
                    success: function (response) {
                        if (response.status === "success") {
                            showSuccess(response.message || "登录成功！");
                            setTimeout(() => {
                                window.location.href = "/homepage";
                            }, 1000);
                        } else {
                            showError(response.message || "登录失败");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Login error:", xhr.responseText);
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            showError(xhr.responseJSON.message);
                        } else {
                            showError("网络错误，请检查网络连接后重试");
                        }
                    }
                });
            });


            $("#register-form").on("submit", function (event) {
                event.preventDefault();

                // 获取表单数据
                const name = $("#register-name").val().trim();
                const identity = $("#register-id").val().trim();
                const email = $("#register-email").val().trim();
                const phone = $("#register-phone").val().trim();
                const password = $("#register-password").val();
                const confirm = $("#register-confirm-password").val();

                // 前端基础验证
                const errors = [];

                if (!name) {
                    errors.push("姓名不能为空");
                } else if (name.length < 2 || name.length > 50) {
                    errors.push("姓名长度必须在2-50个字符之间");
                }

                if (!identity) {
                    errors.push("身份证号不能为空");
                } else if (!/^[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/.test(identity)) {
                    errors.push("身份证号格式不正确");
                }

                if (!phone) {
                    errors.push("手机号不能为空");
                } else if (!/^1[3-9]\d{9}$/.test(phone)) {
                    errors.push("手机号格式不正确");
                }

                if (!email) {
                    errors.push("邮箱不能为空");
                } else if (!/^[A-Za-z0-9+_.-]+@([A-Za-z0-9.-]+\.[A-Za-z]{2,})$/.test(email)) {
                    errors.push("邮箱格式不正确");
                }

                if (!password) {
                    errors.push("密码不能为空");
                } else if (password.length < 6 || password.length > 20) {
                    errors.push("密码长度必须在6-20个字符之间");
                }

                if (password !== confirm) {
                    errors.push("两次输入的密码不一致");
                }

                // 如果有前端验证错误，直接显示
                if (errors.length > 0) {
                    showErrors(errors);
                    return;
                }

                // 发送注册请求（修正字段名）
                $.ajax({
                    url: "/register",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        name: name,        // 修正：rname -> name
                        identity: identity, // 修正：id -> identity
                        email: email,
                        phone: phone,
                        password: password
                    }),
                    success: function (response) {
                        if (response.status === "success") {
                            showSuccess(response.message || "注册成功！");
                            setTimeout(() => {
                                window.location.href = "/";
                            }, 1500);
                        } else if (response.status === "validation_error") {
                            // 处理后端验证错误
                            showErrors(response.details || [response.error]);
                        } else {
                            showError(response.error || "注册失败，请稍后重试");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Registration error:", xhr.responseText);
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            showError(xhr.responseJSON.error);
                        } else {
                            showError("网络错误，请检查网络连接后重试");
                        }
                    }
                });
            });


            $("#forgot-password").on("click", function (event) {
                event.preventDefault();

                const email = prompt("请输入您的注册邮箱:");
                if (!email) return;

                // 验证邮箱格式
                if (!/^[A-Za-z0-9+_.-]+@([A-Za-z0-9.-]+\.[A-Za-z]{2,})$/.test(email)) {
                    showError("邮箱格式不正确");
                    return;
                }

                const password = prompt("请输入新密码:");
                if (!password) return;

                if (password.length < 6) {
                    showError("密码长度至少6位");
                    return;
                }

                $.ajax({
                    url: "/forget_password",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ email, password }),
                    success: function (response) {
                        if (response.status === "success") {
                            showSuccess(response.message);
                        } else {
                            showError(response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Password reset error:", xhr.responseText);
                        showError("密码重置失败，请稍后重试");
                    }
                });
            });

            // 错误和成功消息显示函数
            function showError(message) {
                showMessage(message, 'error');
            }

            function showSuccess(message) {
                showMessage(message, 'success');
            }

            function showErrors(errors) {
                if (Array.isArray(errors) && errors.length > 0) {
                    // 处理多个错误消息，使用换行符分隔
                    const errorMessage = errors.join('\n• ');
                    showMessage(`输入有误：\n• ${errorMessage}`, 'error');
                } else if (typeof errors === 'string') {
                    // 处理单个错误消息
                    showError(errors);
                } else {
                    // 默认错误消息
                    showError("输入数据有误，请检查后重试");
                }
            }

            function showMessage(message, type) {
                // 移除现有的消息框
                $('.message-box').remove();

                // 创建新的消息框
                const messageBox = $(`<div class="message-box message-${type}"></div>`);

                // 设置图标和文本内容
                const icon = type === 'error' ? '❌' : '✅';
                messageBox.text(`${icon} ${message}`);

                $('body').append(messageBox);

                // 3秒后自动消失
                setTimeout(() => {
                    messageBox.addClass('fade-out');
                    setTimeout(() => messageBox.remove(), 500);
                }, 3000);
            }
        });
    </script>
</body>

</html>